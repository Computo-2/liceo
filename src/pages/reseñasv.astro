<br>
<section class="relative w-full overflow-hidden">
  <!-- Track -->
  <div
    id="review-carousel"
    class="flex will-change-transform select-none"
    style="transform: translate3d(0,0,0); transition: transform 0.7s ease;"
  >
    <!-- Slides “base”: usa data-src, no iframe directo -->
    <div class="p-3 carousel-item">
      <div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col h-full">
        <div class="relative aspect-video bg-black">
          <div
            class="absolute inset-0 w-full h-full vimeo-placeholder"
            data-src="https://player.vimeo.com/video/1120240210?title=0&byline=0&portrait=0&autopause=1"
          ></div>
        </div>
        <div class="p-5">
          <p class="italic">“Testimonio de Ex Alumno 1.”</p>
          <div class="mt-4 flex items-center">
            <img src="https://via.placeholder.com/40" alt="Persona 1" class="w-10 h-10 rounded-full mr-3">
            <div>
              <p class="font-semibold">Ex Alumno 1</p>
              <p class="text-sm text-gray-600">Ex Alumno</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="p-3 carousel-item">
      <div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col h-full">
        <div class="relative aspect-video bg-black">
          <div
            class="absolute inset-0 w-full h-full vimeo-placeholder"
            data-src="https://player.vimeo.com/video/1120215980?title=0&byline=0&portrait=0&autopause=1"
          ></div>
        </div>
        <div class="p-5">
          <p class="italic">“Testimonio de Ex Alumno 2.”</p>
          <div class="mt-4 flex items-center">
            <img src="https://via.placeholder.com/40" alt="Persona 2" class="w-10 h-10 rounded-full mr-3">
            <div>
              <p class="font-semibold">Ex Alumno 2</p>
              <p class="text-sm text-gray-600">Ex Alumno</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="p-3 carousel-item">
      <div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col h-full">
        <div class="relative aspect-video bg-black">
          <div
            class="absolute inset-0 w-full h-full vimeo-placeholder"
            data-src="https://player.vimeo.com/video/1120223031?title=0&byline=0&portrait=0&autopause=1"
          ></div>
        </div>
        <div class="p-5">
          <p class="italic">“Testimonio de Ex Alumno 3.”</p>
          <div class="mt-4 flex items-center">
            <img src="https://via.placeholder.com/40" alt="Persona 3" class="w-10 h-10 rounded-full mr-3">
            <div>
              <p class="font-semibold">Ex Alumno 3</p>
              <p class="text-sm text-gray-600">Ex Alumno</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- No clones aquí; se crean por JS -->
  </div>
<br>
  <!-- Controles -->
  <button id="prev" class="absolute top-1/2 left-2 -translate-y-1/2 bg-white/70 p-2 rounded-full shadow">‹</button>
  <button id="next" class="absolute top-1/2 right-2 -translate-y-1/2 bg-white/70 p-2 rounded-full shadow">›</button>
</section>

<script type="module">
  const track = document.getElementById('review-carousel');
  const BTN_NEXT = document.getElementById('next');
  const BTN_PREV = document.getElementById('prev');

  let slidesBase = Array.from(track.querySelectorAll('.carousel-item'));
  let slides; // NodeList después de clonar
  let index = 0; // arrancamos en el primer “real”, pero con clones delante
  let slideWidth = 0;
  let visibleCount = 1; // 1 en móvil, 3 en md+
  let clonesHead = [];
  let clonesTail = [];
  let isAnimating = false;

  function computeVisibleCount() {
    return window.matchMedia('(min-width: 768px)').matches ? 3 : 1;
  }

  function setWidths() {
    // Fijamos ancho real por item (sin depender de basis-1/3)
    const containerWidth = track.parentElement.clientWidth;
    slides = Array.from(track.querySelectorAll('.carousel-item'));
    slides.forEach((s) => {
      s.style.minWidth = `${containerWidth / visibleCount}px`;
      s.style.maxWidth = `${containerWidth / visibleCount}px`;
      s.style.flex = '0 0 auto';
    });
    slideWidth = containerWidth / visibleCount;
  }

  function hydrateIframeIfNeeded(i) {
    // hidrata solo los visibles
    const start = i;
    const end = i + visibleCount - 1;
    for (let k = start; k <= end; k++) {
      const slide = slides[k];
      if (!slide) continue;
      const ph = slide.querySelector('.vimeo-placeholder');
      if (ph && !ph.dataset.mounted) {
        const iframe = document.createElement('iframe');
        iframe.className = 'absolute inset-0 w-full h-full';
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture');
        iframe.setAttribute('allowfullscreen', '');
        iframe.src = ph.dataset.src;
        ph.replaceWith(iframe);
        slide.dataset.vimeoMounted = '1';
        ph.dataset.mounted = '1';
      }
    }
  }

  function pauseAllIframesExcept(i) {
    const start = i;
    const end = i + visibleCount - 1;
    slides.forEach((s, idx) => {
      if (idx >= start && idx <= end) return;
      const iframe = s.querySelector('iframe');
      if (iframe && iframe.contentWindow) {
        // API postMessage de Vimeo para pausar
        iframe.contentWindow.postMessage({ method: 'pause' }, '*');
      }
    });
  }

  function buildClones() {
    // limpia clones anteriores
    clonesHead.forEach(n => n.remove());
    clonesTail.forEach(n => n.remove());
    clonesHead = [];
    clonesTail = [];

    // clonamos N al principio y N al final
    const N = visibleCount;
    const firstN = slidesBase.slice(0, N).map(s => s.cloneNode(true));
    const lastN = slidesBase.slice(-N).map(s => s.cloneNode(true));

    lastN.forEach(c => track.insertBefore(c, track.firstChild));
    firstN.forEach(c => track.appendChild(c));

    clonesHead = firstN;
    clonesTail = lastN;

    // refrescamos lista completa
    slides = Array.from(track.querySelectorAll('.carousel-item'));
    setWidths();

    // colocamos índice inicial justo después de los clones “tail”
    index = clonesTail.length;
    jumpTo(index); // sin transición
    hydrateIframeIfNeeded(index);
  }

  function enableTransition() {
    track.style.transition = 'transform 0.7s ease';
  }
  function disableTransition() {
    track.style.transition = 'none';
  }

  function applyTransform() {
    track.style.transform = `translate3d(${-slideWidth * index}px,0,0)`;
  }

  function jumpTo(i) {
    disableTransition();
    index = i;
    applyTransform();
    // forzamos el frame y re-habilitamos transición para siguientes movimientos
    requestAnimationFrame(() => {
      // leer una prop fuerza reflow en algunos navegadores:
      void track.offsetHeight;
      enableTransition();
    });
  }

  function goNext() {
    if (isAnimating) return;
    isAnimating = true;
    index += 1;
    applyTransform();
  }
  function goPrev() {
    if (isAnimating) return;
    isAnimating = true;
    index -= 1;
    applyTransform();
  }

  // Eventos
  BTN_NEXT.addEventListener('click', goNext);
  BTN_PREV.addEventListener('click', goPrev);

  track.addEventListener('transitionend', () => {
    // loop: si caemos en clones, teletransportamos al equivalente real
    const total = slides.length;
    const baseLen = slidesBase.length;
    // si nos pasamos al bloque final de clones
    if (index >= total - clonesHead.length) {
      const offset = index - (total - clonesHead.length);
      jumpTo(clonesTail.length + offset);
    }
    // si nos pasamos al bloque inicial de clones
    if (index < clonesTail.length) {
      const offset = clonesTail.length - index;
      jumpTo(baseLen + clonesTail.length - offset);
    }
    hydrateIframeIfNeeded(index);
    pauseAllIframesExcept(index);
    isAnimating = false;
  });

  function rebuildAll() {
    visibleCount = computeVisibleCount();
    buildClones();
  }

  // Resize / reflow seguro
  let resizeRaf;
  window.addEventListener('resize', () => {
    cancelAnimationFrame(resizeRaf);
    resizeRaf = requestAnimationFrame(() => {
      setWidths();
      jumpTo(index); // mantiene vista actual
    });
  });

  // Init
  rebuildAll();
</script>
